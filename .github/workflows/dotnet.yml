name: Build, test and publish
on:
  push:
    branches:
      - main

jobs:
  test-scripts-with-local-packages:
    name: Test scripts with local packages
    uses: ./.github/workflows/test-workload.yml@main
    with:
      template: uno
      path: src/workload/Uno.Sdk.Manifest
      source: artifacts/nuget
      
  publish:
    needs: test-scripts-with-local-packages
    name: Build, test and publish
    uses: HavenDV/workflows/.github/workflows/dotnet_build-test-publish.yml@main
    with:
      os: windows-latest
      generate-build-number: false
      conventional-commits-publish-conditions: false
      enable-caching: false
      project-path: src/workload/Uno.Sdk.Manifest
    secrets:
      nuget-key: ${{ secrets.NUGET_KEY }}
      
  wait-nuget:
    name: Wait NuGet packages
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Sleep for 5 minutes
        run: sleep 300s
        shell: bash
        
  test-scripts-with-nuget-packages:
    name: Test scripts with NuGet packages
    needs: wait-nuget
    uses: ./.github/workflows/test-workload.yml@main
    with:
      template: uno